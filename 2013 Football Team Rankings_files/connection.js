define(["jquery","version!fly/managers/debug","../libs/sockjs-0.3.4"],function(c,n){n=n.init("connection");n.enable();var t=function(t){this.server=c.extend(true,{url:{sockjs:{development:"http://dws9024.dev.cbssports.com:8882/torq/handler",qa:"http://node.qa.cbssports.com:8882/torq/handler",production:window.location.protocol+"//torq.cbssports.com/torq/handler"}}},t.servers);this.napi=c.extend(true,{host:{development:"http://api.qa.cbssports.com/napi/util/getTorqStateFile",qa:"http://api.qa.cbssports.com/napi/util/getTorqStateFile",production:window.location.protocol+"//api.cbssports.com/napi/util/getTorqStateFile"},access_token:"23acc7742eb3f95c4f162e969caa4aed380a4bc8"},t.napi);this.eventTimer={};this.eventLog=[];this.socketProgressStatus={code:0,status:"none"};var e={topics:[],eventStateCallback:function(){return null},eventUpdateCallback:function(){return null},websocketServerEnvironment:"production",accessToken:null,maxReconnectAttempts:5,fallbackPollingEnabled:true,fallbackPollingSeconds:12e4,_reconnectTimerId:0,_currentReconnectAttempt:0,_fallbackTimerId:0,_socketStatusCheckTimerId:0,_socketStatusCheckSeconds:3e4};this.options=c.extend({},e,t);this.init()};t.prototype={init:function(){this.startTimer();if(this.hasAccessTokenConfig()&&this.hasTopicsConfig()){this.checkWebSocketSupport()}},hasAccessTokenConfig:function(){if(this.options.accessToken){return true}else{this.logEvent("initialization error","No access token specified");return false}},hasTopicsConfig:function(){if(this.options.topics.length>0){return true}else{this.logEvent("initialization error","No topics specified");return false}},checkWebSocketSupport:function(){var t=this;if(typeof window.WebSocket!="undefined"){this.webSocketSupport=true;this.transport="websocket";this.connect();this.options._socketStatusCheckTimerId=setTimeout(function(){t.socketProgressStatusCheck()},t.options._socketStatusCheckSeconds)}else{this.webSocketSupport=false;this.transport="xhr";this.connect()}},connect:function(){var t=this;this.logEvent("initialize transport",this.transport);if(this.transport=="websocket"){if(this.socket&&this.socket.readyState==SockJS.OPEN){this.socket.close()}this.logEvent("server host",this.server.url.sockjs[this.options.websocketServerEnvironment]);this.setSocketStatusCode("initialize");var e=new SockJS(this.server.url.sockjs[this.options.websocketServerEnvironment]);e.instance=t;e.onopen=t.socketOnOpen;e.onmessage=t.socketOnMessage;e.onclose=t.socketOnClose;e.onerror=t.socketOnError;t.socket=e}else if(this.transport=="xhr"){this.fallbackPolling();this.setFallbackTimer()}},socketOnOpen:function(){this.instance.logEvent("socket onopen",true);this.instance.logEvent("socket protocol",this.protocol);this.instance.setSocketStatusCode("connected");this.instance.options._currentReconnectAttempt=0;this.instance.doLogin()},socketOnMessage:function(e){var o=null;try{o=JSON.parse(e.data)}catch(t){o=e.data}this.instance.onClientData(o)},socketOnClose:function(t){this.instance.logEvent("socket close",t.toString());this.instance.setSocketStatusCode("closed");var e=this;e.socket=null;if(!t.wasClean){if(e.instance.options._currentReconnectAttempt<e.instance.options.maxReconnectAttempts){e.instance.reconnect()}else{e.instance.logEvent("max reconnect attempts","Exceeded max attempts of "+e.instance.options.maxReconnectAttempts+" to reconnect");if(e.instance.options.fallbackPollingEnabled){e.instance.logEvent("failover","Fallback to XHR transport");e.instance.fallbackPolling();e.instance.setFallbackTimer()}}}},socketOnError:function(){this.instance.logEvent("socket_onerror","")},setSocketStatusCode:function(t){var e={none:{code:0,status:"none"},initialize:{code:1,status:"initialize"},open:{code:2,status:"connected"},authorization:{code:3,status:"authorization"},ondata:{code:4,status:"ondata"},closed:{code:5,status:"closed"}};if(typeof e[t]!="undefined"){this.socketProgressStatus=e[t]}},socketProgressStatusCheck:function(){this.logEvent("socket progress status",JSON.stringify(this.socketProgressStatus));if(this.transport=="websocket"&&(this.socketProgressStatus.code>0&&this.socketProgressStatus.code<4)){this.logEvent("failover","Fallback to XHR transport");this.disconnect();this.fallbackPolling();this.setFallbackTimer()}},doLogin:function(){var t={cmd:"login",access_token:this.options.accessToken};this.socket.send(JSON.stringify(t))},initSubscriptions:function(){if(this.transport=="websocket"){this.logEvent("on authorization subscription",this.options.topics);var t={cmd:"subscribe",topics:this.options.topics};this.socket.send(JSON.stringify(t))}},subscribe:function(t){if(t){this.updateTopicList("subscribe",t)}if(this.transport=="websocket"){this.logEvent("subscribe",t);var e={cmd:"subscribe",topics:t};this.socket.send(JSON.stringify(e))}},unsubscribe:function(t){if(t){this.updateTopicList("unsubscribe",t)}if(this.transport=="websocket"){this.logEvent("unsubscribe",this.options.topics);var e={cmd:"unsubscribe",topic:t};this.socket.send(JSON.stringify(e))}},updateTopicList:function(n,t){var i=this;c.each(t,function(t,o){if(n=="subscribe"){var e=c.inArray(o,i.options.topics);if(e==-1){i.options.topics.push(o)}}else if(n=="unsubscribe"){var s=c.grep(i.options.topics,function(t,e){return t!==o});i.options.topics=s}})},reconnect:function(){var t=this;var e=parseInt(5*Math.random()*1e3);t.options._currentReconnectAttempt++;t.logEvent("queue reconnect","Try to reconnect in "+e+" ms");clearTimeout(t.options._reconnectTimerId);t.options._reconnectTimerId=setTimeout(function(){t.logEvent("reconnect","Reconnect attempt #"+t.options._currentReconnectAttempt+" ("+t.options.maxReconnectAttempts+" maximum)");t.connect()},e)},disconnect:function(){if(typeof this.socket!="undefined"&&this.socket.readyState==SockJS.OPEN){this.socket.close()}},getFallbackUrl:function(){var t=[this.napi.host[this.options.websocketServerEnvironment]];var e=this.options.topics.join(",");var o={topics:e,access_token:this.napi.access_token};var s=c.param(o);t.push(s);return t.join("?")},setFallbackTimer:function(){var t=this;t.transport="xhr";clearTimeout(t.options._fallbackTimerId);t.options._fallbackTimerId=setTimeout(function(){t.fallbackPolling()},this.options.fallbackPollingSeconds)},fallbackPolling:function(){var s=this;var t=this.getFallbackUrl();var e=c.ajax({url:t,type:"GET",dataType:"jsonp",crossDomain:true,timeout:1e4});e.done(function(t,e,o){s.logEvent("XHR done response status",e);s.fallbackPollingOnData(t)});e.fail(function(t,e,o){s.logEvent("XHR fail",e,o)})},fallbackPollingOnData:function(t){if(typeof t.topics!="undefined"&&t.topics.length>0){var e=t.topics.length;for(var o=0;o<e;o++){var s=t.topics[o].body,n=t.topics[o].topic,i=t.topics[o].eventType;this.payloadCallback(i,n,s)}this.setFallbackTimer()}},onClientData:function(t){this.parseMessagePayload(t)},parseMessagePayload:function(t){var e=t;if(typeof t.data!="undefined"){e=t.data}if(typeof e.cmd!="undefined"){this.logEvent("cmd",JSON.stringify(e))}else if(e.authorized=="ok"){this.setSocketStatusCode("authorization");this.logEvent("authorization",JSON.stringify(e));this.initSubscriptions()}else if(typeof e.error!="undefined"){this.logEvent("error",JSON.stringify(e));if(e.error.match(/topic denied/i)){this.updateTopicList("unsubscribe",[e.topic])}}else if(typeof e.body!="undefined"){if(typeof e.eventType!="undefined"){var o=e.body,s=e.topic,n=e.eventType;this.setSocketStatusCode("ondata");this.payloadCallback(n,s,o)}else if(typeof e.body=="object"){var o=e.body.param1,s=e.topic,n=e.eventType;this.setSocketStatusCode("ondata");this.payloadCallback(n,s,o)}}},payloadCallback:function(t,e,o){var s=this;s.logEvent(t,e);var n={event:t,topic:e,info:o};switch(t){case"onEvent":s.options.eventStateCallback(n);break;case"setState":s.options.eventStateCallback(n);break;case"update":s.options.eventUpdateCallback(n);break}},startTimer:function(){var t=new Date;this.eventTimer.start=t.getTime()},timeSince:function(){var t,e;t=new Date;msTime=t.getTime()-this.eventTimer.start;return msTime},logEvent:function(t,e){var o={},s=this.timeSince();o.time=s;o.event=t;o.info=e||null;n.log("eventLog",o);this.eventLog.push(o)}};return t});