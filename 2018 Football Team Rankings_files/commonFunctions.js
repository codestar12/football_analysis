define(["libs/debug","translations/core","version!libs/dateformat","libs/getValueFromArray","managers/page-vars","managers/tealium","managers/guid","version!fly/managers/gpt","utils/cookie","version!fly/utils/url-helper","jquery"],function(r,c,o,a,l,i,s,n,u,t,d){r=r.init("common");r.log("common");return{getOrdinalOrOvertime:function(e,a,t,r,n){var i=parseInt(e);var s=this.getOrdinal(i,t);if(r=="mlb"){return s}if(a&&i>a){if(typeof r!="undefined"&&typeof n!="undefined"){if(r=="nhl"){var o=i-a;if(n.toLowerCase()!="postseason"&&o>1){return"SO"}}}s="OT";if(t){s=this.getPeriodValue(i,a)}}return s},isHalftime:function(e){return(e||"").toLowerCase()=="halftime"},getPeriodValue:function(e,a,t,r){var n=e;if(t=="mlb"){return n}if(e>a){var i=e-a;if(typeof t!="undefined"&&typeof r!="undefined"){if(t=="nhl"){if(r.toLowerCase()!="postseason"&&i>1){return"SO"}}}n="OT";if(i>1){n=i+n}}return n},getOrdinal:function(e,a){var t=[,"st","nd","rd"];return(a?e:"")+(t[((e=Math.abs(e%100))-20)%10]||t[e]||"th")},getTeamLogo:function(e,a,t,r,n){var i="",s=e.toLowerCase(),o=a.toUpperCase(),l=t!=undefined?t:false,r=r!=undefined?r:"dark",u=["ncaab","collegebasketball","collegefootball","ncaaf"];e=this.getNormandyArenaForRouting(e);if(u.indexOf(e)!=-1){var d="",g=n!=undefined?n:null,f="";switch(e){case"ncaab":e="collegebasketball";break;case"ncaaf":e="collegefootball";break}if(g!=null){f=g+"x"+g}else{f="90x90"}d=c.default_cdn_host_url+"/images/"+e+"/logos/"+f+"/"+o+".png";return d}if(l==true){s+="/alt"}if(r=="light"){s+="/light"}i=c.default_fly_image_host+"/bundles/sportsmediacss/images/team-logos/"+s+"/"+o+".svg";return i},getFormattedDateHtml:function(e,a,t){if(!e||!a){return}var r=new Date(0),n=new Date;r.setUTCSeconds(e);var i=n.toDateString()==r.toDateString();var s=i&&t?t:a;return o.format.date(r,s)},jqueryObjToString:function(e){if(a(e,"jquery")&&e.length){return e.clone().wrap("<div />").parent().html()}return""},updateHistory:function(e,a,t,r,n,i,s){a=typeof a==="undefined"?false:a;i=typeof i!="undefined"&&i!=null?i:null;s=typeof s!="undefined"&&s!=null?s:null;var o={},l={},u="";if(typeof t!="undefined"){o.tab=t}if(i!=null&&typeof r!="undefined"){l.url=i.replace("%type%",r)}if(s!=null&&typeof n!="undefined"){u=s.replace("%description%",n);l.title=u;o.title=u}if(d.isEmptyObject(o)===false&&d.isEmptyObject(l)===false){l.replace=a;e.navigate(o,l)}},updatePageTracking:function(e,a,t){var r=this,e=typeof e!="undefined"&&e!=null?e:null,a=typeof a!="undefined"&&a!=null?a:null,t=typeof t!="undefined"&&t!=null?t:true,n=a!=null&&e!=null?a.replace("%type%",e):"";if(n!=""){d.ajax({type:"GET",dataType:"json",url:n,data:{trackingRequested:1}}).done(function(e){if(typeof e.trackingData!="undefined"){l.guid=s.generateGuid();l.tracking.data=d.extend(true,{},e.trackingData);i.init(l.tracking.data);i.trackPageLoad(d.extend(true,{},l.tracking.data,{viewguid:s.getViewGuid(),_pageViewGuid:s.getViewGuid(),_taboolaRefreshView:t}))}if(typeof e.adData!="undefined"){var a=false;if(e.destroyAds){googletag.destroySlots();a=true}r.refreshAds(e,a)}})}},refreshAds:function(e,a){r.log("BEGIN _refreshAds");r.log("gpt",n);r.log("Data",e);var t=e||{};try{this._prepareLoadOrRefresh(t,a);if(a){n.loadAds()}else{n.refresh()}}catch(e){r.log("gptMgr.refresh; had trouble: ",e.message)}},_prepareLoadOrRefresh:function(e,a){e=e||{};if(e.adData){var t=l.ads.data.gpt.containerId;l.ads.data=d.extend(true,{},e.adData);l.ads.data.gpt.targeting.vguid=l.guid;l.ads.data.gpt.containerId=t;n.setTargeting("vguid",s.getViewGuid())}if(a){this.setupTargeting();n.init(l.ads.data.gpt)}d.each(l.ads.data.gpt.targeting,function(e,a){n.setTargeting(e,a)})},setupTargeting:function(){var e={region:this._getAdRegion(),targeting:{session:this._selectSessionGroup(),subses:this._selectSubsessionGroup(),vguid:l.guid}};l.ads.data.gpt=d.extend(true,l.ads.data.gpt,e,this._getCookieTargeting(e),this._getQueryTargeting());this._setupAdSuppression()},_getAdRegion:function(){var e=l.ads.data.gpt.adConfig;var a=e.defaultRegion;var t=u.read("fly_geo")?JSON.parse(u.read("fly_geo")):"";if(t&&t.countryCode){var r=e.regions;for(var n=0;n<r.length;n++){var i=r[n];for(var s=0;s<i.countries.length;s++){if(i.countries[s]===t.countryCode){a=i.region}}}}return a},_setupAdSuppression:function(){var e=t.getParamAsArray("adSuppress");if(d.isArray(e)){l.ads.data.gpt.suppressAds=e;r.log("_setupAdSuppression Ads suppressed via query string",e)}else{e=u.read("adSuppress");if(typeof e==="string"){e=e.split(",");l.ads.data.gpt.suppressAds=e}}},_selectSessionGroup:function(){var e="abcd";return e.charAt(Math.floor(Math.random()*e.length))},_selectSubsessionGroup:function(){return Math.ceil(Math.random()*l.ads.data.session).toString()},_getCookieTargeting:function(e){var a=u.read(l.ads.data.cookieName)?JSON.parse(u.read(l.ads.data.cookieName)):null;var t=null;if(!a){u.write(l.ads.data.cookieName,JSON.stringify({region:e.region,session:e.targeting.session,subSession:e.targeting.subses,type:"gpt"}));a=JSON.parse(u.read(l.ads.data.cookieName))}if(a){t={region:a.region,targeting:{session:a.session,subses:a.subSession}}}return t},_getQueryTargeting:function(){var e=this;var i={slotVars:{},targeting:{}};d.each(t.getAllParams(),function(e,a){var t=e.match(/adTargeting_(.+)/);var r=e.match(/ad(.+)/);if(t&&t[1]){i.targeting[t[1]]=a}else if(e==="adNetwork"){i.slotVars.network=a}else if(r&&r[1]){var n=r[1].toLowerCase();if(n==="region"){i[n]=a}else{i.targeting[n]=a}}});return i},getHighlanderLeagueForRouting:function(e){switch(e.toLowerCase()){case"collegebasketball":case"ncaab":return"college-basketball";case"collegefootball":case"ncaaf":return"college-football"}return e},getNormandyArenaForRouting:function(e){switch(e.toLowerCase()){case"college-basketball":return"collegebasketball";case"ncaab":return"collegebasketball";case"college-football":return"collegefootball";case"ncaaf":return"collegefootball"}return e},getCountryFlag:function(e){switch(e){case"ENG":e="GBR";break;case"IRE":e="IRL";break;case"SAF":e="RSA";break;case"SCO":e="SCO";break;case"CHL":e="CHI";break}var a=c.default_fly_image_host;if(window.SportsPageVars.environment=="qa"||window.SportsPageVars.environment=="local"){a="//qa.fly.cbssports.com"}var t=a+"/bundles/sportsmediacss/images/flags/"+e+".svg";return t},getSeoName:function(e){return e.toLowerCase().replace(/[^a-zA-Z0-9\s]/g,"").replace(/\s+/g,"-")},getPlayerUrl:function(e,a){var t="",r=typeof e.id!="undefined"?e.id:null,n=typeof e.first_name!="undefined"&&typeof e.last_name!="undefined"?e.first_name+" "+e.last_name:null,i=n!=null?this.getSeoName(n):null;var s=this.getNormandyArenaForRouting(a);if(r!=null&&i!=null){t="https://"+c.default_media_host+"/"+s+"/players/playerpage/"+r+"/"+i}return t},getTeamUrl:function(e,a,t){var r=SportsPageVars.device=="mobile"?"/":"";var n=c.default_media_host_url+"/"+e+"/teams/page/"+a+"/"+t+r;return n},getPlayerMug:function(e,a,t){var r="",n=typeof e.id!="undefined"?e.id:null,i="",t=typeof t!="undefined"?t:"170x170";switch(a.toLowerCase()){case"nba":i="basketball";break;case"nfl":i="football";break;case"mlb":i="baseball";break}if(n!=null){r=c.default_cdn_host_url+"/images/";r+=i!=""?i+"/":"";r+=a.toLowerCase()+"/players/"+t+"/"+n+".png"}return r},getUserBrowser:function(){var e=navigator.userAgent,a,t=e.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[];if(/trident/i.test(t[1])){a=/\brv[ :]+(\d+)/g.exec(e)||[];return"IE "+(a[1]||"")}if(t[1]==="Chrome"){a=e.match(/\b(OPR|Edge)\/(\d+)/);if(a!=null)return a.slice(1).join(" ").replace("OPR","Opera")}t=t[2]?[t[1],t[2]]:[navigator.appName,navigator.appVersion,"-?"];if((a=e.match(/version\/(\d+)/i))!=null)t.splice(1,1,a[1]);return t.join(" ")},formatPlayerStats:function(e){return _.filter(_.map(e,a),function(e){return!!e}).join(", ");function a(e){var a=e.label;var t=e.value;return!a||!parseInt(t,10)?false:t==1||t==-1?a:t+" "+a+"s"}}}});